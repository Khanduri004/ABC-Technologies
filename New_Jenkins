pipeline {
    agent any
    tools {
        maven 'maven3'
        jdk 'JDK17'
    }

    environment {
        DOCKER_IMAGE = "shreya004/abc_technologies:latest"
        GIT_URL = "https://github.com/Khanduri004/ABC-Technologies.git"
        K8S_NAMESPACE = "abc-technologies"
        PROM_NS = "prometheus-monitoring"
    }

    stages {

        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Clone Repository') {
            steps {
                checkout([$class: 'GitSCM',
                    branches: [[name: "main"]],
                    userRemoteConfigs: [[
                        url: env.GIT_URL,
                        credentialsId: 'github-credentials'
                    ]]
                ])
            }
        }

        stage('Code Coverage Report') {
            steps {
                sh 'mvn clean test jacoco:report'
                publishHTML(target: [
                    allowMissing: true,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'target/site/jacoco',
                    reportFiles: 'index.html',
                    reportName: 'Code Coverage Report'
                ])
            }
        }

        stage('Build Docker Image') {
            steps {
                sh 'docker build -t $DOCKER_IMAGE .'
            }
        }

       stage('Push Docker Image to Docker Hub') {
          steps {
             withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_PASS')]) {
               sh """
                 docker --version
                 echo "Logging in to Docker Hub..."
                 echo "User: $DOCKERHUB_USER"

                 echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USER" --password-stdin

                 docker push $DOCKER_IMAGE
            """
        }
    }
  }
        stage('Install Prometheus & Grafana') {
           steps {
             sh """
               # Update kubeconfig
               aws eks update-kubeconfig --name my-cluster --region eu-west-1

               echo "üîç Checking if Prometheus namespace exists..."
               kubectl get namespace ${PROM_NS} || kubectl create namespace ${PROM_NS}

               echo "üßπ Removing previous failed Prometheus installation..."
               helm uninstall monitoring -n ${PROM_NS} || true

               echo "üßπ Deleting leftover CRDs..."
                kubectl delete crd alertmanagerconfigs.monitoring.coreos.com \
                  alertmanagers.monitoring.coreos.com \
                  prometheusrules.monitoring.coreos.com \
                  prometheuses.monitoring.coreos.com \
                  scrapeconfigs.monitoring.coreos.com \
                  prometheusagents.monitoring.coreos.com \
                  --ignore-not-found

                sleep 5

               echo "üì¶ Adding Helm repo..."
               helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
               helm repo update

               echo "üöÄ Installing kube-prometheus-stack..."
               helm install monitoring prometheus-community/kube-prometheus-stack \
                  --namespace ${PROM_NS} \
                  --set grafana.adminPassword='admin123' \
                  --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false \

               echo "‚úÖ Prometheus & Grafana installation completed."
          """
       }
    }

        stage('Deploy to Kubernetes') {
            steps {
                sh """
                    # Update kubeconfig
                    aws eks update-kubeconfig --name my-cluster --region eu-west-1
                    
                       # Create namespace if doesn't exist
                        kubectl get namespace ${K8S_NAMESPACE} || kubectl create namespace ${K8S_NAMESPACE}
                        
                        # Update image in deployment
                        sed -i 's|image: ${DOCKER_IMAGE}:.*|image: ${DOCKER_IMAGE}|g' kubernetes/deployment.yml
                        
                        # Apply manifests in correct order
                        echo "üì¶ Applying Kubernetes manifests..."
                        
                        kubectl apply -f kubernetes/namespace.yml || true
                        kubectl apply -f kubernetes/persistent_volume.yml
                        kubectl apply -f kubernetes/persistent_volume_claim.yml
                        kubectl apply -f kubernetes/deployment.yml
                        kubectl apply -f kubernetes/service.yml
                        kubectl apply -f kubernetes/hpa.yml
                        kubectl apply -f kubernetes/ingress.yml
                        kubectl apply -f kubernetes/cron_job.yml
                        echo "installing helm......."
                        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
                        helm repo update
                        
                        helm install monitoring prometheus-community/kube-prometheus-stack \
                        --namespace prometheus-monitoring \
                        --create-namespace
                        echo "confirm installation..."
                        kubectl get crds | grep monitor

                        # Try to apply service monitor (skip if Prometheus not installed)
                        kubectl apply -f kubernetes/service_monitor.yml || echo "‚ö†Ô∏è  ServiceMonitor skipped (Prometheus Operator not installed)"
                        
                        # Wait for rollout
                        kubectl rollout status deployment/abc-technologies -n ${K8S_NAMESPACE}
                        
                        # Show status
                        kubectl get pods -n ${K8S_NAMESPACE}
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo "SUCCESS: Pipeline completed successfully!"
            echo "Application deployed with image: ${DOCKER_IMAGE}"
        }
        failure {
            echo "FAILED: Pipeline failed. Please check the logs."
        }
    }
